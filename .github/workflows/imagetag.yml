#name: "CodeQL and Docker Tag"

on:
  push:
    branches: ["github-*"]
  #pull_request:
    #types:
    #  - closed
    #branches: ["main"]
  #workflow_dispatch:

defaults:
  run:
    working-directory: ./application

jobs:
  #image-version:
  #  name: Image Version
  #  runs-on: ubuntu-latest

  #  steps:
  #  - name: path
  #    run: ls -l
      
  #  - name: Check Package Version
  #    run: yq .version ./package.json

  image-tag:
    name: Image
    runs-on: ubuntu-latest
    #needs: containerize
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: List Local Images
        #if: ${{ github.event_name == 'pull_request' && github.event.action == 'unassigned' }}
        run: docker images
      
      - name: List Docker Hub Images
        #if: ${{ github.event_name == 'pull_request' && github.event.action == 'unassigned' }}
        run: docker search ${{secrets.DOCKER_USERNAME}}

      - name: Pull Image
        continue-on-error: true
        run: |
          git --version
          git branch -a
          git checkout -f develop
          git show HEAD~1 | grep commit | head -n 1 | cut -d " " -f 2
          IMAGE_TAG=$(git log -1 | grep commit | cut -d " " -f 2)
          echo "Docker Login"
          docker login -u ${{secrets.DOCKER_USERNAME}} -p ${{secrets.DOCKER_PASSWORD}}
          docker pull ${{vars.APP_IMAGE}}:$IMAGE_TAG
          echo "List Images"
          docker images
